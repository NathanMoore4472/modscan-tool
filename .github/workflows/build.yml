name: Build ModScan Tool

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

permissions:
  contents: write  # Required to upload release assets

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pillow certifi

    - name: Create analytics config
      run: |
        cat > analytics_config.py << 'EOF'
        BACKEND_TYPE = 'supabase'
        SUPABASE_URL = '${{ secrets.SUPABASE_URL }}'
        SUPABASE_KEY = '${{ secrets.SUPABASE_KEY }}'
        HTTP_ENDPOINT_URL = None
        HTTP_API_KEY = None
        TELEMETRY_ENABLED_BY_DEFAULT = True
        TELEMETRY_DEBUG = False
        EOF
      shell: bash

    - name: Build for macOS
      if: matrix.os == 'macos-latest'
      run: |
        # Convert icon if it exists
        if [ -f "icon.png" ]; then
          python3 << EOF
        from PIL import Image
        import os
        iconset_dir = "icon.iconset"
        os.makedirs(iconset_dir, exist_ok=True)
        img = Image.open("icon.png")
        sizes = [16, 32, 64, 128, 256, 512]
        for size in sizes:
          resized = img.resize((size, size), Image.Resampling.LANCZOS)
          resized.save(f"{iconset_dir}/icon_{size}x{size}.png")
          resized = img.resize((size*2, size*2), Image.Resampling.LANCZOS)
          resized.save(f"{iconset_dir}/icon_{size}x{size}@2x.png")
        EOF
          iconutil -c icns icon.iconset
          ICON_ARG="--icon=icon.icns"
        else
          ICON_ARG=""
        fi

        pyinstaller --clean --noconfirm \
          --name "ModScan Tool" \
          --windowed \
          --onedir \
          --add-data "icon.png:." \
          --add-data "analytics_config.py:." \
          --add-data "analytics:analytics" \
          --hidden-import=certifi \
          $ICON_ARG \
          launcher.py

        # Create DMG for distribution
        mkdir -p "dist/dmg"
        # Use ditto instead of cp - it handles .app bundles and symlinks better
        ditto "dist/ModScan Tool.app" "dist/dmg/ModScan Tool.app"
        hdiutil create -volname "ModScan Tool" -srcfolder "dist/dmg" -ov -format UDZO "dist/ModScan-Tool-macOS.dmg"

    - name: Build for Windows
      if: matrix.os == 'windows-latest'
      run: |
        # Convert icon if it exists
        if (Test-Path "icon.png") {
          python -c "from PIL import Image; img = Image.open('icon.png'); img.save('icon.ico', sizes=[(16,16), (32,32), (48,48), (64,64), (128,128), (256,256)])"
          $ICON_ARG = "--icon=icon.ico"
        } else {
          $ICON_ARG = ""
        }

        pyinstaller --clean --noconfirm `
          --name "ModScan Tool" `
          --windowed `
          --onedir `
          --add-data "icon.png;." `
          --add-data "analytics_config.py;." `
          --add-data "analytics;analytics" `
          --hidden-import=certifi `
          $ICON_ARG `
          launcher.py

        # Create standalone folder and rename for clarity
        Move-Item "dist/ModScan Tool" "dist/ModScan-Tool-Windows"

        # Create ZIP for release
        Compress-Archive -Path "dist/ModScan-Tool-Windows" -DestinationPath "dist/ModScan-Tool-Windows.zip"
      shell: pwsh

    - name: Build for Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        if [ -f "icon.png" ]; then
          ICON_ARG="--icon=icon.png"
        else
          ICON_ARG=""
        fi

        pyinstaller --clean --noconfirm \
          --name "modscan-tool" \
          --windowed \
          --onedir \
          --add-data "icon.png:." \
          --add-data "analytics_config.py:." \
          --add-data "analytics:analytics" \
          --hidden-import=certifi \
          $ICON_ARG \
          launcher.py

        # Make executable
        chmod +x dist/modscan-tool/modscan-tool

        # Create tarball for distribution
        tar -czf dist/ModScan-Tool-Linux.tar.gz -C dist modscan-tool

    - name: Upload macOS artifact
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: ModScan-Tool-macOS
        path: |
          dist/ModScan Tool.app
          dist/ModScan-Tool-macOS.dmg

    - name: Upload Windows artifact
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: ModScan-Tool-Windows
        path: dist/ModScan-Tool-Windows

    - name: Upload Linux artifact
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: ModScan-Tool-Linux
        path: dist/ModScan-Tool-Linux.tar.gz

    # Upload macOS to release
    - name: Upload macOS Release
      if: github.event_name == 'release' && matrix.os == 'macos-latest'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/ModScan-Tool-macOS.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Upload Windows to release
    - name: Upload Windows Release
      if: github.event_name == 'release' && matrix.os == 'windows-latest'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/ModScan-Tool-Windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Upload Linux to release
    - name: Upload Linux Release
      if: github.event_name == 'release' && matrix.os == 'ubuntu-latest'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/ModScan-Tool-Linux.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
